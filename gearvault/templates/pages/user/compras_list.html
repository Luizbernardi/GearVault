{% extends 'base.html' %}
{% load static %}

{% block title %}Minhas Compras{% endblock %}

{% block content %}
<div class="container-fluid" id="main-content-panel">
  <div class="row">
    <div class="col-md-2" id="sidebar-panel">
      {% include 'sidebar.html' %}
    </div>
    <div class="col-md-10" id="painel-content">
      <div class="card mt-4 mb-4" style="border: 1px solid #083D77;">
        <div class="card-header text-white" style="background-color: #083D77;">
          <h4 class="mb-0">Minhas Compras</h4>
        </div>
        <div class="card-body">
          <table class="table table-striped table-bordered mt-4">
            <thead>
              <tr>
                <th class="py-3 px-3">Data</th>
                <th class="py-3 px-3">Fornecedor</th>
                <th class="py-3 px-3">Estoque</th>
                <th class="py-3 px-3">Valor Total</th>
                <th class="py-3 px-3">Nota Fiscal</th>
                <th class="py-3 px-3"></th>
              </tr>
            </thead>
            <tbody>
            {% for compra in compras %}
              <tr>
                <td class="py-2">{{ compra.data|date:'d/m/Y' }}</td>
                <td class="py-2">{{ compra.fornecedor.nome }}</td>
                <td class="py-2">{{ compra.estoque.nome }}</td>
                <td class="py-2">R$ {{ compra.valor_total|floatformat:2 }}</td>
                <td class="py-2">
                  {% if compra.invoice %}
                    <a href="{{ compra.invoice.url }}" target="_blank" class="btn btn-sm btn-outline-primary">Ver Invoice</a>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td class="py-2">
                  <button class="btn btn-sm rounded-circle d-inline-flex align-items-center text-white justify-content-center"
                    style="width: 36px; height: 36px; background-color: #083D77;"
                    data-bs-toggle="modal"
                    data-bs-target="#detalhesCompraModal"
                    data-compra-id="{{ compra.id }}"
                    title="Ver Detalhes">
                    <i class="bi bi-eye"></i>
                  </button>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="6" class="text-center py-4">Nenhuma compra encontrada.</td></tr>
            {% endfor %}
            </tbody>
          </table>
          <!-- Paginação -->
          <div class="d-flex justify-content-center align-items-center mb-3 mt-5">
            <nav aria-label="Navegação de página" class="d-flex justify-content-center mb-0">
              <ul class="pagination mb-0">
                {% if compras.number > 1 %}
                  <li class="page-item"><a class="page-link" href="?page=1">« Primeira</a></li>
                {% else %}
                  <li class="page-item disabled"><span class="page-link">« Primeira</span></li>
                {% endif %}
                {% if compras.has_previous %}
                  <li class="page-item"><a class="page-link" href="?page={{ compras.previous_page_number }}">Anterior</a></li>
                {% else %}
                  <li class="page-item disabled"><span class="page-link">Anterior</span></li>
                {% endif %}
                <li class="page-item disabled">
                  <span class="page-link text-white" style="background-color: #083D77; border-color: #083D77;">
                    Página {{ compras.number }} de {{ compras.paginator.num_pages }}
                  </span>
                </li>
                {% if compras.has_next %}
                  <li class="page-item"><a class="page-link" href="?page={{ compras.next_page_number }}">Próxima</a></li>
                {% else %}
                  <li class="page-item disabled"><span class="page-link">Próxima</span></li>
                {% endif %}
                {% if compras.number < compras.paginator.num_pages %}
                  <li class="page-item"><a class="page-link" href="?page={{ compras.paginator.num_pages }}">Última »</a></li>
                {% else %}
                  <li class="page-item disabled"><span class="page-link">Última »</span></li>
                {% endif %}
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Detalhes da Compra -->
<div class="modal fade" id="detalhesCompraModal" tabindex="-1" aria-labelledby="detalhesCompraModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header" style="background-color: #083D77;">
        <h5 class="modal-title text-white" id="detalhesCompraModalLabel">Detalhes da Compra</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="modal-detalhes-compra-content">
          <div class="text-center text-muted">Carregando detalhes...</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<style>
  #painel-content {
    transition: width 0.3s cubic-bezier(0.4,0,0.2,1), margin-left 0.3s cubic-bezier(0.4,0,0.2,1);
  }
  #sidebar-panel {
    transition: width 0.3s cubic-bezier(0.4,0,0.2,1), display 0.3s cubic-bezier(0.4,0,0.2,1);
  }
  .badge {
    font-size: 0.875rem;
  }
</style>
<script src="{% static 'painel-content-resize.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const detalhesModal = document.getElementById('detalhesCompraModal');
  detalhesModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const compraId = button.getAttribute('data-compra-id');
    const content = document.getElementById('modal-detalhes-compra-content');
    content.innerHTML = '<div class="text-center text-muted">Carregando detalhes...</div>';
    fetch(`/usuario/compras/${compraId}/detalhes/`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          let html = `<div class='mb-3'><strong>Data:</strong> ${data.compra.data} <br><strong>Fornecedor:</strong> ${data.compra.fornecedor} <br><strong>Estoque:</strong> ${data.compra.estoque} <br><strong>Valor Total:</strong> R$ ${data.compra.valor_total} <br>`;
          if (data.compra.invoice_url) {
            html += `<strong>Nota Fiscal:</strong> <a href='${data.compra.invoice_url}' target='_blank'>Ver Invoice</a><br>`;
          }
          html += '</div>';
          html += `<h6>Itens da Compra:</h6><table class='table table-sm'><thead><tr><th>Produto</th><th>Local</th><th>Quantidade</th><th>Valor Unitário</th><th>Subtotal</th></tr></thead><tbody>`;
          data.itens.forEach(item => {
            html += `<tr><td>${item.produto}</td><td>${item.local}</td><td>${item.quantidade}</td><td>R$ ${item.valor_unitario}</td><td>R$ ${item.subtotal}</td></tr>`;
          });
          html += '</tbody></table>';
          content.innerHTML = html;
        } else {
          content.innerHTML = `<div class='text-danger'>${data.error || 'Erro ao carregar detalhes.'}</div>`;
        }
      })
      .catch(() => {
        content.innerHTML = '<div class="text-danger">Erro ao carregar detalhes da compra.</div>';
      });
  });
});
</script>
{% endblock %}
