{% extends 'base.html' %}
{% load static %}

{% block title %}Nova Compra{% endblock %}

{% block content %}
<div class="container-fluid" id="main-content-panel">
  <div class="row">
    <div class="col-md-2" id="sidebar-panel">
      {% include 'sidebar.html' %}
    </div>
    <div class="col-md-10" id="painel-content">
      <div class="card mt-4 mb-4" style="border: 1px solid #083D77;">
        <div class="card-header text-white" style="background-color: #083D77;">
          <h4 class="mb-0">Nova Compra</h4>
        </div>
        <div class="card-body">
          <form method="post" enctype="multipart/form-data" id="formNovaCompra">
            {% csrf_token %}
            <div class="row mb-3">
              <div class="col-md-4 mb-3">
                <label for="estoque" class="form-label">Estoque</label>
                <select class="form-select" name="estoque" id="estoque" required>
                  <option value="">Selecione...</option>
                  {% for estoque in estoques %}
                    <option value="{{ estoque.id }}">{{ estoque.nome }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-4 mb-3">
                <label for="local" class="form-label">Local de Armazenamento</label>
                <select class="form-select" name="local" id="local" required>
                  <option value="">Selecione o estoque primeiro</option>
                </select>
              </div>
              <div class="col-md-4 mb-3">
                <label for="fornecedor" class="form-label">Fornecedor</label>
                <select class="form-select" name="fornecedor" id="fornecedor" required>
                  <option value="">Selecione...</option>
                  {% for fornecedor in fornecedores %}
                    <option value="{{ fornecedor.id }}">{{ fornecedor.nome }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6 mb-3">
                <label for="invoice" class="form-label">Nota Fiscal (Invoice)</label>
                <input type="file" class="form-control" name="invoice" id="invoice" accept="application/pdf,image/*">
              </div>
            </div>
            <hr>
            <h5>Itens da Compra</h5>
            <div class="table-responsive">
              <table class="table table-bordered align-middle" id="tabela-itens">
                <thead>
                  <tr>
                    <th>Produto</th>
                    <th>Quantidade</th>
                    <th>Valor Unitário (R$)</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="itens-body">
                  <tr>
                    <td>
                      <select class="form-select" name="produto[]" required>
                        <option value="">Selecione...</option>
                        {% for produto in produtos %}
                          <option value="{{ produto.id }}">{{ produto.nome }}</option>
                        {% endfor %}
                      </select>
                    </td>
                    <td><input type="number" class="form-control" name="quantidade[]" min="1" required></td>
                    <td><input type="number" class="form-control" name="valor_unitario[]" min="0" step="0.01" required></td>
                    <td class="text-center"><button type="button" class="btn btn-danger btn-sm btn-remove-item">&times;</button></td>
                  </tr>
                </tbody>
              </table>
              <button type="button" class="btn btn-outline-primary" id="btn-add-item">Adicionar Item</button>
            </div>
            <div class="mt-4 d-flex justify-content-end">
              <button type="submit" class="btn text-white" style="background-color: #083D77; width: 200px;">Salvar Compra</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  #painel-content {
    transition: width 0.3s cubic-bezier(0.4,0,0.2,1), margin-left 0.3s cubic-bezier(0.4,0,0.2,1);
  }
  #sidebar-panel {
    transition: width 0.3s cubic-bezier(0.4,0,0.2,1), display 0.3s cubic-bezier(0.4,0,0.2,1);
  }
</style>
<script src="{% static 'painel-content-resize.js' %}"></script>
<script>
// Atualiza locais conforme estoque selecionado
const locaisPorEstoque = {};
{% for estoque in estoques %}
  locaisPorEstoque[{{ estoque.id }}] = [
    {% for local in estoque.locais.all %}
      {id: {{ local.id }}, nome: "{{ local.nome|escapejs }}"},
    {% endfor %}
  ];
{% endfor %}

document.getElementById('estoque').addEventListener('change', function() {
  const estoqueId = this.value;
  const localSelect = document.getElementById('local');
  localSelect.innerHTML = '<option value="">Selecione...</option>';
  if (locaisPorEstoque[estoqueId]) {
    locaisPorEstoque[estoqueId].forEach(function(local) {
      const opt = document.createElement('option');
      opt.value = local.id;
      opt.textContent = local.nome;
      localSelect.appendChild(opt);
    });
  } else {
    localSelect.innerHTML = '<option value="">Nenhum local disponível</option>';
  }
});

// Adicionar/remover itens dinamicamente
const btnAddItem = document.getElementById('btn-add-item');
const itensBody = document.getElementById('itens-body');
btnAddItem.addEventListener('click', function() {
  const row = document.createElement('tr');
  row.innerHTML = `
    <td>
      <select class="form-select" name="produto[]" required>
        <option value="">Selecione...</option>
        {% for produto in produtos %}
          <option value="{{ produto.id }}">{{ produto.nome }}</option>
        {% endfor %}
      </select>
    </td>
    <td><input type="number" class="form-control" name="quantidade[]" min="1" required></td>
    <td><input type="number" class="form-control" name="valor_unitario[]" min="0" step="0.01" required></td>
    <td class="text-center"><button type="button" class="btn btn-danger btn-sm btn-remove-item">&times;</button></td>
  `;
  itensBody.appendChild(row);
});
itensBody.addEventListener('click', function(e) {
  if (e.target.classList.contains('btn-remove-item')) {
    const row = e.target.closest('tr');
    if (itensBody.rows.length > 1) row.remove();
  }
});
</script>
{% endblock %}
